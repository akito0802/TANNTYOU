<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>調の長短スイッチャー</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;background:#0b0f1a;color:#e9eefc}
    header{padding:18px 16px;border-bottom:1px solid rgba(255,255,255,.08);position:sticky;top:0;background:rgba(11,15,26,.92);backdrop-filter: blur(10px);z-index:10}
    h1{margin:0;font-size:18px}
    .wrap{padding:16px;max-width:980px;margin:0 auto}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,button,textarea{background:#111a33;color:#e9eefc;border:1px solid rgba(255,255,255,.16);border-radius:12px;padding:10px 12px;font-size:14px}
    textarea{width:100%;min-height:90px;resize:vertical;line-height:1.5}
    button{cursor:pointer}
    button.active{outline:2px solid rgba(255,255,255,.35)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);margin:6px 6px 0 0}
    .muted{opacity:.75}
    .hi{font-weight:700}
    .delta{color:#ffd166}
    .note{font-variant-numeric:tabular-nums}
    .small{font-size:12px}
    footer{opacity:.7;font-size:12px;padding:16px;text-align:center}
    .warn{color:#ffb3b3}
  </style>
</head>
<body>
<header>
  <div class="wrap row" style="justify-content:space-between">
    <h1>調の長短スイッチャー（Major ↔ Minor）</h1>
    <div class="small muted">Key / スケール / ダイアトニック / 進行変換</div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="row">
      <label class="muted">Key：</label>
      <select id="keySel"></select>

      <label class="muted" style="margin-left:6px">Mode：</label>
      <div class="row" style="gap:8px">
        <button id="majBtn" class="active">Major</button>
        <button id="minBtn">Minor</button>
      </div>
    </div>

    <div class="row muted" style="margin-top:10px">
      <span class="pill">同主調：<span class="hi" id="parallelText"></span></span>
      <span class="pill">相対調：<span class="hi" id="relativeText"></span></span>
      <span class="pill">差分：<span class="hi delta" id="diffText"></span></span>
    </div>

    <div class="small muted" style="margin-top:10px;line-height:1.6">
      ※「短長切替」は基本 <b>同主調（C↔Cm）</b> の比較が一番わかりやすいよ。<br>
      ※このページのマイナーは <b>自然短音階（ナチュラルマイナー）</b> をベースにしてる。
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="hi">スケール</div>
      <div id="scaleBox" class="note" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="hi">ダイアトニックコード</div>
      <div id="chordBox" class="note" style="margin-top:10px"></div>
    </div>
  </div>

  <div class="card">
    <div class="hi">コード進行の「短 ↔ 長」切替（同主調）</div>
    <div class="muted small" style="margin-top:8px;line-height:1.6">
      入力は <b>ローマ数字</b> がいちばん確実。区切りはスペース/ハイフン/改行どれでもOK。<br>
      例：<b>I - V - vi - IV</b> / <b>i - VII - VI - VII</b> / <b>ii° V i</b>
    </div>

    <div style="margin-top:10px">
      <textarea id="progIn" placeholder="例：I - V - vi - IV"></textarea>
    </div>

    <div class="row" style="margin-top:10px;justify-content:space-between">
      <div class="row">
        <button id="convertBtn">変換する</button>
        <button id="sampleBtn">サンプル入れる</button>
      </div>
      <div class="small muted">今のMode → 反対のMode に変換して表示</div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="card" style="margin:0">
        <div class="hi">いまのModeで鳴らすと</div>
        <div id="progNow" class="note" style="margin-top:10px"></div>
      </div>
      <div class="card" style="margin:0">
        <div class="hi">反対のModeに切り替えると</div>
        <div id="progOther" class="note" style="margin-top:10px"></div>
      </div>
    </div>

    <div id="progMsg" class="small muted" style="margin-top:10px"></div>
  </div>

  <footer>index.html 1枚で動作します（GitHub PagesにそのままOK）</footer>
</div>

<script>
  // 12音（#表記で統一）
  const NOTES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

  // メジャー / 自然短音階
  const MAJOR = [0,2,4,5,7,9,11];
  const MINOR = [0,2,3,5,7,8,10];

  // ダイアトニックの質
  const QUAL_MAJ = ["","m","m","","","m","dim"];   // I ii iii IV V vi vii°
  const QUAL_MIN = ["m","dim","","m","m","",""];  // i ii° III iv v VI VII（自然短音階）

  const ROMAN_MAJ = ["I","ii","iii","IV","V","vi","vii°"];
  const ROMAN_MIN = ["i","ii°","III","iv","v","VI","VII"];

  const keySel = document.getElementById("keySel");
  const majBtn = document.getElementById("majBtn");
  const minBtn = document.getElementById("minBtn");
  const scaleBox = document.getElementById("scaleBox");
  const chordBox = document.getElementById("chordBox");
  const parallelText = document.getElementById("parallelText");
  const relativeText = document.getElementById("relativeText");
  const diffText = document.getElementById("diffText");

  const progIn = document.getElementById("progIn");
  const convertBtn = document.getElementById("convertBtn");
  const sampleBtn = document.getElementById("sampleBtn");
  const progNow = document.getElementById("progNow");
  const progOther = document.getElementById("progOther");
  const progMsg = document.getElementById("progMsg");

  // Key一覧
  NOTES.forEach(n=>{
    const o=document.createElement("option");
    o.value=n;o.textContent=n;keySel.appendChild(o);
  });

  let mode="major";

  function idx(n){return NOTES.indexOf(n);}
  function noteAt(r,s){return NOTES[(r+s)%12];}

  function buildScale(root, mode){
    const r=idx(root);
    const steps=mode==="major"?MAJOR:MINOR;
    return steps.map(s=>noteAt(r,s));
  }

  function buildChords(root, mode){
    const r=idx(root);
    const steps=mode==="major"?MAJOR:MINOR;
    const qual=mode==="major"?QUAL_MAJ:QUAL_MIN;
    const roman=mode==="major"?ROMAN_MAJ:ROMAN_MIN;

    return steps.map((s,i)=>{
      const n = noteAt(r,s);
      const q = qual[i];
      const name = q==="dim" ? `${n}dim` : `${n}${q}`;
      return {degree:i, roman:roman[i], name};
    });
  }

  function relativeKeyText(root){
    const r=idx(root);
    if(mode==="major"){
      // 相対短調：-3半音
      return `${root} Major ↔ ${NOTES[(r+9)%12]} Minor`;
    }else{
      // 相対長調：+3半音
      return `${root} Minor ↔ ${NOTES[(r+3)%12]} Major`;
    }
  }

  function render(){
    const root=keySel.value;

    // スケール表示
    const sc=buildScale(root, mode);
    scaleBox.innerHTML=sc.map(n=>`<span class="pill">${n}</span>`).join("");

    // ダイアトニック表示
    const ch=buildChords(root, mode);
    chordBox.innerHTML=ch.map(x=>`<span class="pill"><span class="muted">${x.roman}</span><span class="hi">${x.name}</span></span>`).join("");

    // 関係表示
    parallelText.textContent=`${root} Major ↔ ${root} Minor`;
    relativeText.textContent=relativeKeyText(root);
    diffText.textContent=mode==="major" ? "3,6,7度が♭になる" : "3,6,7度が♮になる";

    // 進行の再描画（入力があれば）
    if(progIn.value.trim().length){
      convertProgression();
    }else{
      progNow.innerHTML = "";
      progOther.innerHTML = "";
      progMsg.textContent = "";
    }
  }

  // --- 進行変換（同主調で degree は固定し、Modeを反転） ---

  function tokenizeProgression(text){
    // 区切り：スペース / 改行 / ハイフン / スラッシュ / カンマ
    return text
      .replace(/[–—−]/g, "-")
      .split(/[\s,
\/]+|-/g)
      .map(t=>t.trim())
      .filter(Boolean);
  }

  function romanToDegree(token){
    // 例：vii°, ii°, III, iv など
    // 1) 記号を除去しつつ、ローマ数字部分を抽出
    const cleaned = token
      .replace(/^[()［］\[\]{}]+|[()［］\[\]{}]+$/g, "")
      .replace(/°/g, "")
      .replace(/dim/ig, "")
      .replace(/maj7|m7|7|sus2|sus4|add9|6|9|11|13/ig, ""); // 入力に混ざってても無視（ローマ数字優先）

    // ローマ数字だけ残す
    const romanPart = (cleaned.match(/[ivIV]+/g) || [""])[0];
    if(!romanPart) return null;

    const upper = romanPart.toUpperCase();
    const map = {"I":0,"II":1,"III":2,"IV":3,"V":4,"VI":5,"VII":6};
    return (upper in map) ? map[upper] : null;
  }

  function pillsFromItems(items){
    return items.map(x=>`<span class="pill"><span class="muted">${x.roman}</span><span class="hi">${x.name}</span></span>`).join("");
  }

  function convertProgression(){
    const root = keySel.value;
    const tokens = tokenizeProgression(progIn.value);

    const chordsNow = buildChords(root, mode);
    const otherMode = (mode==="major") ? "minor" : "major";
    const chordsOther = buildChords(root, otherMode);

    const okNow = [];
    const okOther = [];
    const bad = [];

    for(const t of tokens){
      const deg = romanToDegree(t);
      if(deg===null){
        bad.push(t);
        continue;
      }
      okNow.push(chordsNow[deg]);
      okOther.push(chordsOther[deg]);
    }

    progNow.innerHTML = okNow.length ? pillsFromItems(okNow) : "<span class='muted'>（まだ入力がないよ）</span>";
    progOther.innerHTML = okOther.length ? pillsFromItems(okOther) : "<span class='muted'>（まだ入力がないよ）</span>";

    if(bad.length){
      progMsg.innerHTML = `<span class="warn">読めなかった：</span> ${bad.map(x=>`<b>${escapeHtml(x)}</b>`).join(", ")}<br>
      <span class="muted">ヒント：ローマ数字（I, ii, V, vi, vii° など）で入力してね。</span>`;
    }else{
      progMsg.textContent = `OK：${tokens.length}個のコードを、${root}の同主調で「${mode} → ${otherMode}」に変換したよ。`;
    }
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
  }

  // イベント
  majBtn.onclick=()=>{mode="major";majBtn.classList.add("active");minBtn.classList.remove("active");render();}
  minBtn.onclick=()=>{mode="minor";minBtn.classList.add("active");majBtn.classList.remove("active");render();}
  keySel.onchange=render;

  convertBtn.onclick = convertProgression;

  sampleBtn.onclick = ()=>{
    // その時のmodeに合わせてサンプルを変える
    progIn.value = (mode==="major")
      ? "I - V - vi - IV"
      : "i - VII - VI - VII";
    convertProgression();
  };

  // 初期値
  keySel.value="C";
  render();
</script>
</body>
</html>
